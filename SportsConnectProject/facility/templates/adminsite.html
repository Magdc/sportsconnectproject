{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12 text-center">
            <h1 class="display-4" style="font-family: 'Helvetica', sans-serif; font-weight: bold;">Panel de administrador</h1>
            <p class="lead mt-3" style="font-family: 'Helvetica', sans-serif;">Desde aqu√≠ podr√° gestionar todo lo relacionado con los espacios deportivos, desde las reservas hasta los usuarios.</p>
        </div>
    </div>

    <!-- Desplegable para Espacios -->
    <div class="accordion mt-5" id="accordionExample">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne" style="font-family: 'Helvetica', sans-serif; font-weight: bold;">
                    Espacios
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <div class="d-flex justify-content-between mb-3">
                        <h5 style="font-family: 'Helvetica', sans-serif; font-weight: bold;">Lista de Espacios</h5>
                        <a href="{% url 'crear_espacio' %}" class="btn" style="background-color: #000053; color: #ffffff;">Crear Espacio</a>
                    </div>
                    <ul class="list-group">
                        {% for facility in facilities %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="font-family: 'Helvetica', sans-serif;">
                                {{ facility.name }}
                                <div>
                                    <a href="{% url 'restringir_acceso' facility.idFacility %}" class="btn" style="background-color: #000053; color: #ffffff;">Restringir acceso</a>
                                    <a href="{% url 'editar_espacio' facility.idFacility %}" class="btn" style="background-color: #ffc107; color: #ffffff;" disabled>Modificar</button>
                                    <a href="{% url 'eliminar_espacio' facility.idFacility %}" class="btn btn-danger btn-sm">Eliminar</a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Desplegable para Reservas -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo" style="font-family: 'Helvetica', sans-serif; font-weight: bold;">
                    Reservas
                </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <ul class="list-group">
                        {% for reserva in reservas %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="font-family: 'Helvetica', sans-serif;">
                                Reserva ID: {{ reserva.id }} - {{ reserva.facilities.name }} ({{ reserva.date }} - {{ reserva.availability.time_slot }})
                                <div>
                                    <a href="{% url 'eliminar_reservacion' reserva.id %}" class="btn btn-danger btn-sm">Eliminar</a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Desplegable para Usuarios -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree" style="font-family: 'Helvetica', sans-serif; font-weight: bold;">
                    Usuarios
                </button>
            </h2>
            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <ul class="list-group">
                        {% for user in users %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="font-family: 'Helvetica', sans-serif;">
                                {{ user.first_name }} {{ user.last_name }} ({{ user.email }})
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Desplegable para Estad√≠sticas de Calificaciones -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingFour">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour" style="font-family: 'Helvetica', sans-serif; font-weight: bold;">
                    üìä Estad√≠sticas de Calificaciones
                </button>
            </h2>
            <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <!-- Resumen Global -->
                    <div class="card mb-3" style="background-color: #f8f9fa;">
                        <div class="card-body">
                            <h5 class="card-title" style="font-family: 'Helvetica', sans-serif; font-weight: bold;">Resumen Global</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Total de Calificaciones:</strong> {{ total_ratings }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Promedio Global:</strong> 
                                        <span class="text-warning" style="font-size: 1.3rem;">{{ avg_rating_global }}‚òÖ</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estad√≠sticas por Espacio -->
                    <h6 style="font-family: 'Helvetica', sans-serif; font-weight: bold;">Calificaciones por Espacio</h6>
                    {% if rating_stats %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Espacio</th>
                                        <th>Promedio</th>
                                        <th>Total Calificaciones</th>
                                        <th>√öltima Actualizaci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in rating_stats %}
                                    <tr>
                                        <td style="font-weight: bold;">{{ stat.facility.name }}</td>
                                        <td>
                                            <span class="text-warning" style="font-size: 1.1rem;">
                                                {{ stat.average_rating }}‚òÖ
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ stat.total_ratings }}</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ stat.last_updated|date:"d/m/Y H:i" }}</small>
                                        </td>
                                        <td>
                                            <a href="{% url 'rating:facility_ratings' stat.facility.idFacility %}" 
                                               class="btn btn-sm btn-outline-primary">
                                                Ver Rese√±as
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info" role="alert">
                            <strong>Sin datos:</strong> A√∫n no hay calificaciones en el sistema.
                        </div>
                    {% endif %}

                    <!-- Espacios sin Calificaciones -->
                    <h6 class="mt-4" style="font-family: 'Helvetica', sans-serif; font-weight: bold;">Espacios sin Calificaciones</h6>
                    {% with unrated_facilities=facilities|length rated_count=rating_stats|length %}
                        {% if unrated_facilities > rated_count %}
                            <div class="alert alert-warning" role="alert">
                                <strong>Atenci√≥n:</strong> Hay {{ unrated_facilities|add:"-"|add:rated_count }} espacio(s) sin calificaciones a√∫n.
                            </div>
                            <ul class="list-group">
                                {% for facility in facilities %}
                                    {% if not facility.rating_stats %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ facility.name }}
                                            <span class="badge bg-secondary">Sin calificaciones</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-success" role="alert">
                                ‚úÖ Todos los espacios tienen al menos una calificaci√≥n.
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}